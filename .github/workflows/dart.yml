name: Build iOS IPA

on:
  push:
    branches:
      - master
jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Godot
        run: |
          curl -L https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_macos.universal.zip -o godot.zip
          unzip godot.zip -d godot
          chmod +x godot/Godot.app/Contents/MacOS/Godot
        id: godot

      - name: Download Export Templates
        run: |
          curl -L https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz -o templates.tpz
          mkdir -p ~/Library/Application\ Support/Godot/export_templates/4.3.stable/
          tar -xf templates.tpz -C ~/Library/Application\ Support/Godot/export_templates/

      - name: Move iOS Export Template to Correct Directory
        run: |
          mkdir -p ~/Library/Application\ Support/Godot/export_templates/4.3.stable/
          mv ~/Library/Application\ Support/Godot/export_templates/templates/ios.zip ~/Library/Application\ Support/Godot/export_templates/4.3.stable/
          
      - name: Export Godot Project for iOS
        run: |
          mkdir -p build
          ./godot/Godot.app/Contents/MacOS/Godot --headless --export-release "iOS" build/ios_project.zip
        continue-on-error: true
        
      - name: Build Xcode Project (Unsigned)
        run: |
          cd build
          xcodebuild -project ios_project.xcodeproj -scheme ios_project -sdk iphoneos -configuration Release -destination generic/platform=iOS archive -archivePath ios_project.xcarchive CODE_SIGNING_ALLOWED=NO
      
      - name: Package Unsigned IPA
        run: |
          cd build/ios_project.xcarchive/Products/Applications
          mkdir -p Payload
          mv *.app Payload/
          zip -r ../ios_project.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios_project.ipa
          path: build/ios_project.xcarchive/Products/ios_project.ipa
